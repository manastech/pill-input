(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G=function(a,b){return function(){return a.apply(b,arguments)}};f="button",l="div",D="SPAN",e="BR",a="A",t="menu",p="input",z="pill",c="arrow",y="option",A="pillButton",k="data-option",x="move",s="link",b="all",E="text",m="dragover",n="drop",q="keydown",r="keyup",h="contextmenu",u="mousedown",v="mousemove",w="mouseup",g="click",o="focus",d="blur",i="copy",j="cut",B=function(){function a(a,b){this.dom=a,this.options=b,this.dom.attr("contentEditable",!0),this.dom.addClass(p),this.dom.on("input",function(a){return function(){return a.trigger("pillinput:changed")}}(this)),this.options.droppedObject||(this.options.droppedObject=function(){return null}),this.controller=new C(this),this.safe_html=$("<div/>")}return a.prototype.on=function(a,b){return this.dom.on(a,b)},a.prototype.trigger=function(){return this.dom.trigger.apply(this.dom,arguments)},a.prototype.value=function(a){return 1===arguments.length?this._renderValue(this.dom,a):$.map(this.dom.contents(),function(a){return function(b){return b.nodeType===Node.TEXT_NODE?b.textContent:a.pillData($(b))}}(this))},a.prototype.droppedObject=function(){return this.options.droppedObject()},a.prototype.pillData=function(a,b){return 1===arguments.length?a.data("pill-info"):2===arguments.length?a.attr("data-pill-info",JSON.stringify(b)):void 0},a.prototype.selectedText=function(){return this.controller.selectedText()},a.prototype.replaceSelectedTextWith=function(a){return this.controller.replaceSelectedTextWith(a)},a.prototype._renderValue=function(a,b){var c,d,e,f;for(c="",e=0,f=b.length;f>e;e++)d=b[e],c+="string"==typeof d?this._htmlEscape(d):this._renderObject(d);return a.html(c)},a.prototype._htmlEscape=function(a){return this.safe_html.text(a).html()},a.prototype._renderObject=function(a){var b,c;return b=$("<a/>").addClass(z).attr("draggable",!0).attr("contentEditable",!1),this.pillData(b,a),this.options.renderPill(a,b),c=b[0].outerHTML,b.remove(),c},a}(),C=function(){function d(a){this.pillInput=a,this.pasteHandler=G(this.pasteHandler,this),this.cutHandler=G(this.cutHandler,this),this.copyHandler=G(this.copyHandler,this),this.blurHandler=G(this.blurHandler,this),this.mouseUpHandler=G(this.mouseUpHandler,this),this.mouseMoveHandler=G(this.mouseMoveHandler,this),this.mouseDownHandler=G(this.mouseDownHandler,this),this.clickHandler=G(this.clickHandler,this),this.keyUpHandler=G(this.keyUpHandler,this),this.keyDownHandler=G(this.keyDownHandler,this),this.dropHandler=G(this.dropHandler,this),this.dragOverHandler=G(this.dragOverHandler,this),this.dragLeaveHandler=G(this.dragLeaveHandler,this),this.dragEnterHandler=G(this.dragEnterHandler,this),this.dragEndHandler=G(this.dragEndHandler,this),this.dragStartHandler=G(this.dragStartHandler,this),this.selectHandler=G(this.selectHandler,this),this.pillInput.dom.on("dragstart",this.dragStartHandler),this.pillInput.dom.on("dragend",this.dragEndHandler),this.pillInput.dom.on("dragenter",this.dragEnterHandler),this.pillInput.dom.on("dragleave",this.dragLeaveHandler),this.pillInput.dom.on("dragover",this.dragOverHandler),this.pillInput.dom.on("drop",this.dropHandler),this.pillInput.dom.on("keydown",this.keyDownHandler),this.pillInput.dom.on("keyup",this.keyUpHandler),this.pillInput.dom.on("contextmenu",this.clickHandler),this.pillInput.dom.on("click",this.clickHandler),this.pillInput.dom.on("mousedown",this.mouseDownHandler),this.pillInput.dom.on("blur",this.blurHandler),this.pillInput.dom.on("copy",this.copyHandler),this.pillInput.dom.on("cut",this.cutHandler),this.pillInput.dom.on("paste",this.pasteHandler),this.dragElement=null,this.dragSource=null}return d.prototype.selectedText=function(){var a,b,c,d,e;return e=this.getRange(),this.inputContainsRange(e)?(c=e.endContainer.nextSibling,a=this.toArray(this.getElementsFromRange(e,!0).childNodes),b=this.getAncestor(p,e.endContainer),d="",a.forEach(function(a){switch(a.nodeType){case Node.ELEMENT_NODE:return d+=a.textContent;case Node.TEXT_NODE:return d+=a.data}}),d):null},d.prototype.replaceSelectedTextWith=function(a){var b,c,d;return c=this.getRange(),this.inputContainsRange(c)?(this.getElementsFromRange(c,!1),b=this.pillInput.dom[0],d=document.createElement(l),this.pillInput._renderValue($(d),[a]),c.insertNode(d.firstChild),this.pillInput.trigger("pillinput:changed")):void 0},d.prototype.insert=function(a){var b,c,d;return a instanceof Array||(a=[a]),d=this.getRange(),d&&!d.collapsed&&(this.deleteSelection(),d=this.getRange()),c=d.startContainer,c.nodeType===Node.TEXT_NODE?(c=c.splitText(d.startOffset),b=c.parentNode,a.forEach(function(a){b.insertBefore(a,c)})):a.forEach(c.classList.contains(p)?function(a){c.appendChild(a)}:function(a){b.insertBefore(a,c)})},d.prototype.insertAtPosition=function(a,b,c){var d,e,f,g;return a instanceof Array||(a=[a]),g=this.getRangeFromPoint(b,c),e=g.offsetNode||g.startContainer,f=g.offset||g.startOffset,e.nodeType===Node.TEXT_NODE?(d=e.parentNode,e=e.splitText(f),a.forEach(function(a){d.insertBefore(a,e)})):a.forEach(function(a){e.appendChild(a)})},d.prototype.sanitize=function(a){return a.normalize(),a.hasChildNodes()&&a.firstChild.nodeName===e&&a.removeChild(a.firstChild),$("span:not([class])",$(a)).contents().unwrap(),$("*",$(a)).removeAttr("style")},d.prototype.inputContainsRange=function(a){var b;return b=!1,a&&!a.collapsed&&this.getAncestor(p,a.commonAncestorContainer)&&(b=!0),b},d.prototype.intersectsRange=function(a,b){var c;return c=!1,b&&(c=b.intersectsNode(a)),c},d.prototype.getRange=function(){return null!=window.getSelection&&window.getSelection().rangeCount>0?window.getSelection().getRangeAt(0):null},d.prototype.getRangeFromPoint=function(a,b){return document.caretPositionFromPoint?document.caretPositionFromPoint(a,b):document.caretRangeFromPoint?document.caretRangeFromPoint(a,b):null},d.prototype.getElementsFromRange=function(a,b){return b?a.cloneContents():a.extractContents()},d.prototype.setSelection=function(a){return window.getSelection().addRange(a)},d.prototype.clearSelection=function(){return window.getSelection?window.getSelection().removeAllRanges():document.selection?document.selection.empty():void 0},d.prototype.deleteSelection=function(){var a;if(window.getSelection){if(a=window.getSelection(),a.deleteFromDocument(),!a.isCollapsed)return a.collapseToEnd()}else if(document.selection)return document.selection.clear()},d.prototype.getAncestor=function(a,b){var c;for(c=null;b&&b!==document&&null===c;)b.classList&&b.classList.contains(a)&&(c=b),b=b.parentNode;return c},d.prototype.toArray=function(a){return[].map.call(a,function(a){return a})},d.prototype.documentFragmentToString=function(a){var b;return b="",this.toArray(a.childNodes).forEach(function(a){switch(a.nodeType){case Node.ELEMENT_NODE:return b+=a.outerHTML;case Node.TEXT_NODE:return b+=a.data}}),b},d.prototype.selectHandler=function(a){var b,c,d,e;if(this.getAncestor(p,a))return d=this.getRange(),e=d&&d.getBoundingClientRect(),b=this.getAncestor(p,a),b&&(c=this.pillInput.dom[0]),this.toArray(c.childNodes).forEach(function(a){a.nodeType===Node.ELEMENT_NODE&&(d&&d.intersectsNode(a)&&e.width?a.classList.add(o):a.classList.contains(z)&&d&&d.collapsed&&!d.startOffset&&d.startContainer.previousSibling===a?a.classList.add(o):a.classList.remove(o))})},d.prototype.dragStartHandler=function(a){var c,d,e;return e=this.getRange(),d=this.getAncestor(z,a.target),c=null,d?this.inputContainsRange(e)&&this.intersectsRange(d,e)?(this.dragElement=this.getElementsFromRange(e,!0),this.dragSource=this.getAncestor(p,e.commonAncestorContainer),c=this.documentFragmentToString(this.dragElement)):(this.dragElement=d,this.dragSource=d.parentNode,c=d.outerHTML,this.pillInput.trigger("pillinput:pilldragstart",{pill:this.pillInput.pillData($(d))})):this.inputContainsRange(e)&&(this.dragElement=this.getElementsFromRange(e,!0),this.dragSource=this.getAncestor(p,e.commonAncestorContainer),c=this.documentFragmentToString(this.dragElement)),c?(a.originalEvent.dataTransfer.effectAllowed=b,a.originalEvent.dataTransfer.setData(E,c),a.stopPropagation()):void 0},d.prototype.dragEndHandler=function(){return this.dragSource=null},d.prototype.dragEnterHandler=function(a){var b;return b=a.target},d.prototype.dragLeaveHandler=function(a){var b;return b=a.target},d.prototype.dragOverHandler=function(a){var b;return b=a.target,"true"===b.contenteditable||bowser.firefox?void 0:a.preventDefault()},d.prototype.dropHandler=function(a){var b,c,d,e;return d=a.target,e=document.createElement(l),b=this.pillInput.droppedObject(),b?this.pillInput._renderValue($(e),[b]):e.innerHTML=a.originalEvent.dataTransfer.getData(E),d.classList.remove(m),d.classList.contains(p)&&(c=this.toArray(e.childNodes),this.insertAtPosition(c,a.originalEvent.clientX,a.originalEvent.clientY),d===this.dragSource&&(this.deleteSelection(),this.dragElement.classList&&this.dragElement.classList.contains(z)&&this.dragElement.parentNode.removeChild(this.dragElement))),this.sanitize(d),this.clearSelection(),this.pillInput.trigger("pillinput:changed"),a.preventDefault()},d.prototype.keyDownHandler=function(b){var c,d,f;if(c=this.getAncestor(p,b.target)){switch(b.keyCode){case 8:if(d=this.getRange(),d&&d.collapsed)switch(f=null,d.startContainer.nodeType){case Node.ELEMENT_NODE:if(f=c.childNodes[d.startOffset-1])switch(f.nodeName){case e:case a:break;default:f=null}break;case Node.TEXT_NODE:d.startOffset||(f=d.startContainer.previousSibling)}}return f&&(c.removeChild(f),b.preventDefault()),window.setTimeout(this.selectHandler,25,c)}},d.prototype.keyUpHandler=function(a){var b;return(b=this.getAncestor(p,a.target))?(this.selectHandler(b),this.sanitize(b),this.pillInput.trigger("pillinput:changed")):void 0},d.prototype.clickHandler=function(a){var b,d,e,f;return e=this.getAncestor(z,a.target),d=this.getAncestor(p,a.target),b=a.target.className===c,f=3===a.which,this.selectHandler(d),e&&(b||f)?(a.stopPropagation(),a.preventDefault(),this.pillInput.trigger("pillinput:pillclick",{pill:this.pillInput.pillData($(e)),dom:$(e)})):void 0},d.prototype.mouseDownHandler=function(a){return this.pillInput.dom.on(v,this.mouseMoveHandler),this.pillInput.dom.on(w,this.mouseUpHandler),this.selectHandler(a.target)},d.prototype.mouseMoveHandler=function(a){return this.selectHandler(a.target)},d.prototype.mouseUpHandler=function(a){return this.pillInput.dom.off(v),this.pillInput.dom.off(w),this.selectHandler(a.target),this.pillInput.trigger("pillinput:selection")},d.prototype.blurHandler=function(a){return this.selectHandler(a.target)},d.prototype.copyHandler=function(a){var b,c,d,e;return d=this.getAncestor(p,a.target),e=this.getRange(),this.inputContainsRange(e)?(c=this.toArray(this.getElementsFromRange(e,!0).childNodes),b="",c.forEach(function(a){switch(a.nodeType){case Node.TEXT_NODE:return b+=a.data;case Node.ELEMENT_NODE:return b+=a.outerHTML}}),a.originalEvent.clipboardData.setData(E,b),a.preventDefault()):void 0},d.prototype.cutHandler=function(a){var b,c;return this.copyHandler(a),b=this.getAncestor(p,a.target),c=this.getRange(),b&&c?this.deleteSelection():void 0},d.prototype.pasteHandler=function(a){var b,c,d,e;return c=this.getAncestor(p,a.target),c?(e=document.createElement(l),e.innerHTML=a.originalEvent.clipboardData.getData(E).replace(/\r?\n/g," "),b=this.toArray(e.childNodes),this.insert(b),d=document.createRange(),d.setStartAfter(b[b.length-1]),this.clearSelection(),this.setSelection(d),this.selectHandler(c),a.preventDefault(),this.pillInput.trigger("pillinput:changed")):void 0},d}(),F="undefined"!=typeof exports&&null!==exports?exports:window,F.PillInput=B}).call(this);