(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=function(a,b){return function(){return a.apply(b,arguments)}};e="button",k="div",B="SPAN",d="BR",a="A",r="menu",o="input",x="pill",b="arrow",w="option",y="pillButton",j="data-option",v="move",C="text",l="dragover",m="drop",p="keydown",q="keyup",g="contextmenu",s="mousedown",t="mousemove",u="mouseup",f="click",n="focus",c="blur",h="copy",i="cut",z=function(){function a(a,b){this.dom=a,this.options=b,this.dom.attr("contentEditable",!0),this.dom.addClass(o),this.dom.on("input",function(a){return function(){return a.trigger("pillinput:changed")}}(this)),this.options.droppedObject||(this.options.droppedObject=function(){return null}),this.controller=new A(this),this.safe_html=$("<div/>")}return a.prototype.on=function(a,b){return this.dom.on(a,b)},a.prototype.trigger=function(){return this.dom.trigger.apply(this.dom,arguments)},a.prototype.value=function(a){return 1===arguments.length?this._renderValue(this.dom,a):$.map(this.dom.contents(),function(a){return function(b){return b.nodeType===Node.TEXT_NODE?b.textContent:a.pillData($(b))}}(this))},a.prototype.droppedObject=function(){return this.options.droppedObject()},a.prototype.pillData=function(a,b){return 1===arguments.length?a.data("pill-info"):2===arguments.length?a.attr("data-pill-info",JSON.stringify(b)):void 0},a.prototype.selectedText=function(){return this.controller.selectedText()},a.prototype.replaceSelectedTextWith=function(a){return this.controller.replaceSelectedTextWith(a)},a.prototype._renderValue=function(a,b){var c,d,e,f;for(c="",e=0,f=b.length;f>e;e++)d=b[e],c+="string"==typeof d?this._htmlEscape(d):this._renderObject(d);return a.html(c)},a.prototype._htmlEscape=function(a){return this.safe_html.text(a).html()},a.prototype._renderObject=function(a){var b,c;return b=$("<a/>").addClass(x).attr("draggable",!0).attr("contentEditable",!1),this.pillData(b,a),this.options.renderPill(a,b),c=b[0].outerHTML,b.remove(),c},a}(),A=function(){function c(a){this.pillInput=a,this.pasteHandler=E(this.pasteHandler,this),this.cutHandler=E(this.cutHandler,this),this.copyHandler=E(this.copyHandler,this),this.blurHandler=E(this.blurHandler,this),this.mouseUpHandler=E(this.mouseUpHandler,this),this.mouseMoveHandler=E(this.mouseMoveHandler,this),this.mouseDownHandler=E(this.mouseDownHandler,this),this.clickHandler=E(this.clickHandler,this),this.keyUpHandler=E(this.keyUpHandler,this),this.keyDownHandler=E(this.keyDownHandler,this),this.dropHandler=E(this.dropHandler,this),this.dragOverHandler=E(this.dragOverHandler,this),this.dragLeaveHandler=E(this.dragLeaveHandler,this),this.dragEnterHandler=E(this.dragEnterHandler,this),this.dragEndHandler=E(this.dragEndHandler,this),this.dragStartHandler=E(this.dragStartHandler,this),this.selectHandler=E(this.selectHandler,this),this.pillInput.dom.on("dragstart",this.dragStartHandler),this.pillInput.dom.on("dragend",this.dragEndHandler),this.pillInput.dom.on("dragenter",this.dragEnterHandler),this.pillInput.dom.on("dragleave",this.dragLeaveHandler),this.pillInput.dom.on("dragover",this.dragOverHandler),this.pillInput.dom.on("drop",this.dropHandler),this.pillInput.dom.on("keydown",this.keyDownHandler),this.pillInput.dom.on("keyup",this.keyUpHandler),this.pillInput.dom.on("contextmenu",this.clickHandler),this.pillInput.dom.on("click",this.clickHandler),this.pillInput.dom.on("mousedown",this.mouseDownHandler),this.pillInput.dom.on("blur",this.blurHandler),this.pillInput.dom.on("copy",this.copyHandler),this.pillInput.dom.on("cut",this.cutHandler),this.pillInput.dom.on("paste",this.pasteHandler),this.dragElement=null,this.dragSource=null}return c.prototype.selectedText=function(){var a,b,c,d,e;return e=this.getRange(),this.inputContainsRange(e)?(c=e.endContainer.nextSibling,a=this.toArray(this.getElementsFromRange(e,!0).childNodes),b=this.getAncestor(o,e.endContainer),d="",a.forEach(function(a){switch(a.nodeType){case Node.ELEMENT_NODE:return d+=a.textContent;case Node.TEXT_NODE:return d+=a.data}}),d):null},c.prototype.replaceSelectedTextWith=function(a){var b,c,d;return c=this.getRange(),this.inputContainsRange(c)?(this.getElementsFromRange(c,!1),b=this.pillInput.dom[0],d=document.createElement(k),this.pillInput._renderValue($(d),[a]),c.insertNode(d.firstChild),this.pillInput.trigger("pillinput:changed")):void 0},c.prototype.insert=function(a){var b,c,d;return a instanceof Array||(a=[a]),d=this.getRange(),d&&!d.collapsed&&(this.deleteSelection(),d=this.getRange()),c=d.startContainer,c.nodeType===Node.TEXT_NODE?(c=c.splitText(d.startOffset),b=c.parentNode,a.forEach(function(a){b.insertBefore(a,c)})):a.forEach(c.classList.contains(o)?function(a){c.appendChild(a)}:function(a){b.insertBefore(a,c)})},c.prototype.insertAtPosition=function(a,b,c){var d,e,f,g;return a instanceof Array||(a=[a]),g=this.getRangeFromPoint(b,c),e=g.offsetNode||g.startContainer,f=g.offset||g.startOffset,e.nodeType===Node.TEXT_NODE?(d=e.parentNode,e=e.splitText(f),a.forEach(function(a){d.insertBefore(a,e)})):a.forEach(function(a){e.appendChild(a)})},c.prototype.sanitize=function(a){return a.normalize(),a.hasChildNodes()&&a.firstChild.nodeName===d&&a.removeChild(a.firstChild),$("span",$(a)).contents().unwrap(),$("*",$(a)).removeAttr("style")},c.prototype.inputContainsRange=function(a){var b;return b=!1,a&&!a.collapsed&&this.getAncestor(o,a.commonAncestorContainer)&&(b=!0),b},c.prototype.intersectsRange=function(a,b){var c;return c=!1,b&&(c=b.intersectsNode(a)),c},c.prototype.getRange=function(){return null!=window.getSelection&&window.getSelection().rangeCount>0?window.getSelection().getRangeAt(0):null},c.prototype.getRangeFromPoint=function(a,b){return document.caretPositionFromPoint?document.caretPositionFromPoint(a,b):document.caretRangeFromPoint?document.caretRangeFromPoint(a,b):null},c.prototype.getElementsFromRange=function(a,b){return b?a.cloneContents():a.extractContents()},c.prototype.setSelection=function(a){return window.getSelection().addRange(a)},c.prototype.clearSelection=function(){return window.getSelection?window.getSelection().removeAllRanges():document.selection?document.selection.empty():void 0},c.prototype.deleteSelection=function(){var a;if(window.getSelection){if(a=window.getSelection(),a.deleteFromDocument(),!a.isCollapsed)return a.collapseToEnd()}else if(document.selection)return document.selection.clear()},c.prototype.getAncestor=function(a,b){var c;for(c=null;b&&b!==document&&null===c;)b.classList&&b.classList.contains(a)&&(c=b),b=b.parentNode;return c},c.prototype.toArray=function(a){return[].map.call(a,function(a){return a})},c.prototype.documentFragmentToString=function(a){var b;return b="",this.toArray(a.childNodes).forEach(function(a){switch(a.nodeType){case Node.ELEMENT_NODE:return b+=a.outerHTML;case Node.TEXT_NODE:return b+=a.data}}),b},c.prototype.selectHandler=function(a){var b,c,d,e;if(this.getAncestor(o,a))return d=this.getRange(),e=d&&d.getBoundingClientRect(),b=this.getAncestor(o,a),b&&(c=this.pillInput.dom[0]),this.toArray(c.childNodes).forEach(function(a){a.nodeType===Node.ELEMENT_NODE&&(d&&d.intersectsNode(a)&&e.width?a.classList.add(n):a.classList.contains(x)&&d&&d.collapsed&&!d.startOffset&&d.startContainer.previousSibling===a?a.classList.add(n):a.classList.remove(n))})},c.prototype.dragStartHandler=function(a){var b,c,d;return d=this.getRange(),c=this.getAncestor(x,a.target),b=null,c?this.inputContainsRange(d)&&this.intersectsRange(c,d)?(this.dragElement=this.getElementsFromRange(d,!0),this.dragSource=this.getAncestor(o,d.commonAncestorContainer),b=this.documentFragmentToString(this.dragElement)):(this.dragElement=c,this.dragSource=c.parentNode,b=c.outerHTML,this.pillInput.trigger("pillinput:pilldragstart",{pill:this.pillInput.pillData($(c))})):this.inputContainsRange(d)&&(this.dragElement=this.getElementsFromRange(d,!0),this.dragSource=this.getAncestor(o,d.commonAncestorContainer),b=this.documentFragmentToString(this.dragElement)),b?(a.originalEvent.dataTransfer.effectAllowed=v,a.originalEvent.dataTransfer.setData(C,b),a.stopPropagation()):void 0},c.prototype.dragEndHandler=function(){return this.dragSource=null},c.prototype.dragEnterHandler=function(a){var b;return b=a.target},c.prototype.dragLeaveHandler=function(a){var b;return b=a.target},c.prototype.dragOverHandler=function(a){var b;return b=a.target,"true"===b.contenteditable||bowser.firefox?void 0:a.preventDefault()},c.prototype.dropHandler=function(a){var b,c,d,e;return d=a.target,e=document.createElement(k),b=this.pillInput.droppedObject(),b?this.pillInput._renderValue($(e),[b]):e.innerHTML=a.originalEvent.dataTransfer.getData(C),d.classList.remove(l),d.classList.contains(o)&&(c=this.toArray(e.childNodes),this.insertAtPosition(c,a.originalEvent.clientX,a.originalEvent.clientY),d===this.dragSource&&(this.deleteSelection(),this.dragElement.classList&&this.dragElement.classList.contains(x)&&this.dragElement.parentNode.removeChild(this.dragElement))),this.sanitize(d),this.clearSelection(),this.pillInput.trigger("pillinput:changed"),a.preventDefault()},c.prototype.keyDownHandler=function(b){var c,e,f;if(c=this.getAncestor(o,b.target)){switch(b.keyCode){case 8:if(e=this.getRange(),e&&e.collapsed)switch(f=null,e.startContainer.nodeType){case Node.ELEMENT_NODE:if(f=c.childNodes[e.startOffset-1])switch(f.nodeName){case d:case a:break;default:f=null}break;case Node.TEXT_NODE:e.startOffset||(f=e.startContainer.previousSibling)}}return f&&(c.removeChild(f),b.preventDefault()),window.setTimeout(this.selectHandler,25,c)}},c.prototype.keyUpHandler=function(a){var b;return(b=this.getAncestor(o,a.target))?(this.selectHandler(b),this.sanitize(b),this.pillInput.trigger("pillinput:changed")):void 0},c.prototype.clickHandler=function(a){var c,d,e,f;return e=this.getAncestor(x,a.target),d=this.getAncestor(o,a.target),c=a.target.className===b,f=3===a.which,this.selectHandler(d),e&&(c||f)?(a.stopPropagation(),a.preventDefault(),this.pillInput.trigger("pillinput:pillclick",{pill:this.pillInput.pillData($(e)),dom:$(e)})):void 0},c.prototype.mouseDownHandler=function(a){return this.pillInput.dom.on(t,this.mouseMoveHandler),this.pillInput.dom.on(u,this.mouseUpHandler),this.selectHandler(a.target)},c.prototype.mouseMoveHandler=function(a){return this.selectHandler(a.target)},c.prototype.mouseUpHandler=function(a){return this.pillInput.dom.off(t),this.pillInput.dom.off(u),this.selectHandler(a.target),this.pillInput.trigger("pillinput:selection")},c.prototype.blurHandler=function(a){return this.selectHandler(a.target)},c.prototype.copyHandler=function(a){var b,c,d,e;return d=this.getAncestor(o,a.target),e=this.getRange(),this.inputContainsRange(e)?(c=this.toArray(this.getElementsFromRange(e,!0).childNodes),b="",c.forEach(function(a){switch(a.nodeType){case Node.TEXT_NODE:return b+=a.data;case Node.ELEMENT_NODE:return b+=a.outerHTML}}),a.originalEvent.clipboardData.setData(C,b),a.preventDefault()):void 0},c.prototype.cutHandler=function(a){var b,c;return this.copyHandler(a),b=this.getAncestor(o,a.target),c=this.getRange(),b&&c?this.deleteSelection():void 0},c.prototype.pasteHandler=function(a){var b,c,d,e;return c=this.getAncestor(o,a.target),c?(e=document.createElement(k),e.innerHTML=a.originalEvent.clipboardData.getData(C),b=this.toArray(e.childNodes),this.insert(b),d=document.createRange(),d.setStartAfter(b[b.length-1]),this.clearSelection(),this.setSelection(d),this.selectHandler(c),a.preventDefault(),this.pillInput.trigger("pillinput:changed")):void 0},c}(),D="undefined"!=typeof exports&&null!==exports?exports:window,D.PillInput=z}).call(this);